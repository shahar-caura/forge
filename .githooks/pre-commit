#!/usr/bin/env bash
# Forge pre-commit hook: runs the same checks as CI so failures are caught locally.
# Install: git config core.hooksPath .githooks
set -euo pipefail

# Only check staged Go files.
STAGED_GO=$(git diff --cached --name-only --diff-filter=ACM -- '*.go' || true)
if [ -z "$STAGED_GO" ]; then
    exit 0
fi

echo "pre-commit: goimports..."
if command -v goimports &>/dev/null; then
    echo "$STAGED_GO" | xargs goimports -w
    echo "$STAGED_GO" | xargs git diff --exit-code -- >/dev/null 2>&1 || {
        echo "pre-commit: goimports produced changes â€” re-staged."
        echo "$STAGED_GO" | xargs git add
    }
else
    echo "pre-commit: goimports not found, skipping format check"
    echo "  install: go install golang.org/x/tools/cmd/goimports@latest"
fi

echo "pre-commit: go vet..."
go vet ./...

if command -v golangci-lint &>/dev/null; then
    echo "pre-commit: golangci-lint..."
    golangci-lint run ./...
else
    echo "pre-commit: golangci-lint not found, skipping lint"
    echo "  install: go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest"
fi

echo "pre-commit: go build..."
go build ./cmd/forge/

echo "pre-commit: OK"
